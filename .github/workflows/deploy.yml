name: Deploy code

on:
  workflow_call:
    inputs:
      environment:
        description: on which env to deploy current branch
        required: true
        type: string
      text:
        description: message to display during deployment
        required: true
        type: string

jobs:
  publish-branch:
    name: Publish / ${{ inputs.environment }}
    env:
      APP_NAME: ${{ github.event.repository.name }}
    runs-on: ubuntu-latest
    steps:
      - name: "MS Teams start deployment"
        uses: toko-bifrost/ms-teams-deploy-card@master #  or "./" if in a local set-up
        if: always()
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
          show-on-start: true
          card-layout-start: complete
          environment: ${{ inputs.environment }}
          include-files: false

      # Calculate destination folder name
      - name: Calculate destination folder
        id: dst-folder
        run: echo "##[set-output name=folder]$(date +%F.%H%M%S)"

      # Download artifact
      - name: Download artifact
        if: (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.ref_name == 'develop') 
          || (github.event_name == 'workflow_dispatch')
        uses: actions/download-artifact@v3
        with:
          name: artifact
          path: ./dist/apps/

      # Download release Asset
      - name: Download release Asset
        if: github.event_name == 'release'
        env:
          ASSET: ${{ github.event.release.assets[0].name }}
        uses: dsaltares/fetch-gh-release-asset@1.0.0
        with:
          file: ${{ env.ASSET }}
          target: ./dist/apps/

      # Unzip release asset
      - name: Unzip release asset
        if: (github.event_name == 'release')
        run: unzip ${{ github.event.release.assets[0].name }}
        working-directory: ./dist/apps/

      # Checkout Smartpush action
      - name: Checkout Smartpush action
        uses: actions/checkout@v3
        with:
          repository: Smart-Push/github-actions
          ref: v1.0.5
          token: ${{ secrets.REPOS_ACCESS_TOKEN }}
          path: ./.github/actions

      # Get hosts matrix
      - name: Get hosts matrix
        id: hosts-matrix
        uses: ./.github/actions/hosts-matrix
      - name: Prepare SSH
        uses: shimataro/ssh-key-action@v2.4.0
        with:
          key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          known_hosts: ${{ secrets.DEPLOY_KNOWN_HOST }}

      # Deploy code
      - name: Deploy code
        env:
          username: ${{ fromJSON(steps.hosts-matrix.outputs.host)[inputs.environment] }}
          target: ~/${{ env.APP_NAME }}/releases/${{ steps.dst-folder.outputs.folder }}
        run: |
          scp -r dist/apps/${{ env.APP_NAME }}/ ${{ env.username }}@${{ secrets.DEPLOY_SSH_HOST }}:${{ env.target }}
          ssh ${{ env.username }}@${{ secrets.DEPLOY_SSH_HOST }} <<EOF
            cd ${{ env.APP_NAME }} && if [ -L current ]; then unlink current; fi && ln -fs releases/${{ steps.dst-folder.outputs.folder }} current
            cd current && ln -fs ~/shared/data
          EOF

      # Teams - deployment result
      - name: MS Teams deployment result
        uses: toko-bifrost/ms-teams-deploy-card@master #  or "./" if in a local set-up
        if: always()
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
          show-on-exit: true
          card-layout-exit: compact